using GoRogue.Random;
using Mut8.Scripts.Core;
using Mut8.Scripts.MapObjects;
using Mut8.Scripts.MapObjects.Components;
using Mut8.Scripts.Maps;
using Mut8.Scripts.Screens.Surfaces;
using Mut8.Scripts.UI;
using ShaiRandom.Generators;

namespace Mut8.Scripts.Screens
{
    internal class MainGame : ScreenObject
    {
        public GameMap? Map;
        public MessageLogPanel? MessagePanel;
        public Player? Player;
        public StatusPanel? StatusPanel;
        public ScreenObject? StatusLayoutContainer;
        public VerticalLayoutComponent? StatusLayoutComponent;
        public GameLoop GameLoop;

        private const int MAP_WIDTH = 100;
        private const int MAP_HEIGHT = 60;
        private const int MESSAGE_LOG_HEIGHT = 5;
        private const int STATUS_PANEL_WIDTH = 30;
        private const string MAP_FONT_NAME = "kenney_combined";

        public event EventHandler? PlayerCreated;

        public MainGame()
        {
            GameLoop = new GameLoop();

            CreateMessagePanel();

            CreateStatusPanel();
        }

        public override void Update(TimeSpan delta)
        {
            base.Update(delta);

            GameLoop.Process();
        }

        private void CreateStatusPanel()
        {
            // Create a container screen object for the layout
            StatusLayoutContainer = new ScreenObject()
            {
                Parent = this,
                Position = new(Engine.WINDOW_WIDTH - STATUS_PANEL_WIDTH, 0)
            };

            // Create and add the vertical layout component
            StatusLayoutComponent = new VerticalLayoutComponent(STATUS_PANEL_WIDTH, Engine.WINDOW_HEIGHT);
            StatusLayoutContainer.SadComponents.Add(StatusLayoutComponent);

            // Create the status panel and add it to the layout group
            StatusPanel = new StatusPanel(STATUS_PANEL_WIDTH, Engine.WINDOW_HEIGHT)
            {
                Parent = StatusLayoutContainer,
                Position = new(0, 0)
            };
            StatusLayoutComponent.AddChild(StatusPanel, flexGrow: 1f);
            //layoutHandle.MaxSize = Engine.WINDOW_HEIGHT / 2;
        }

        private void CreateMessagePanel()
        {
            MessagePanel = new MessageLogPanel(Engine.WINDOW_WIDTH - STATUS_PANEL_WIDTH, MESSAGE_LOG_HEIGHT)
            {
                Parent = this,
                Position = new(0, Engine.WINDOW_HEIGHT - MESSAGE_LOG_HEIGHT)
            };
        }

        private void CreateMap()
        {
            Map = MapFactory.GenerateDungeonMap(MAP_WIDTH, MAP_HEIGHT);

            IFont font = GameHost.Instance.Fonts[MAP_FONT_NAME];
            Map.DefaultRenderer = Map.CreateRenderer(
                new Point(Engine.WINDOW_WIDTH - STATUS_PANEL_WIDTH, Engine.WINDOW_HEIGHT - MESSAGE_LOG_HEIGHT).TranslateFont(
                    GameHost.Instance.DefaultFont.GetFontSize(IFont.Sizes.One),
                    font.GetFontSize(IFont.Sizes.One)
                ),
                font
            );

            Children.Add(Map);
            Map.IsFocused = true;
        }

        private void CreatePlayer()
        {
            // Generate player, add to map at a random walkable position, and calculate initial FOV
            Player = new Player();
            Player.Position = GlobalRandom.DefaultRNG.RandomPosition(Map!.WalkabilityView, true);
            Map.AddEntity(Player);
            Player.AllComponents.GetFirst<PlayerFOVController>().CalculateFOV();
            PlayerCreated?.Invoke(this, EventArgs.Empty);
        }

        internal void StartGame()
        {
            CreateMap();

            CreatePlayer();

            StatusPanel?.SetPlayer(Player);

            // @PG: removing this because it makes the camera update only after every turn is done instead of as soon as the position changes.
            // That made the camera lag behind a bit. Instead, in MoveAction, I recenter the camera ASAP
            // Center view on player as they move
            //SadConsole.Components.SurfaceComponentFollowTarget viewLock = new() { Target = Player };
            //Map.DefaultRenderer?.SadComponents.Add(viewLock);
        }
    }
}
